{% extends 'base.html' %}

{% block head %}
<title>Quiz</title>
{% endblock %}

{% block main %}
<div id="loading-spinner" class="spinner hidden"></div>
<div class="quiz-box" id="quiz-box">
    <h2 class="question" id="question">
    Question {{ index + 1 }} of {{ quiz|length }}: 
    {{ quiz[index].question|safe }}
    </h2>


    <div class="option" id="options">
        {% for opt in quiz[index].options %}
        <label class="quiz-option">
            <input type="radio" name="answer" value="{{ opt }}"/>
            <span class="custom-radio"></span>
            {{ opt }}
        </label>
        {% endfor %}
    </div>

    <div class="feedback" id="feedback"></div>

    <nav class="quiz-nav">
        <button class="check-btn" id="check-btn">Check</button>
        <button class="next-btn" id="next-btn" style="display:none;">Next</button>
        <button class="submit-btn" id="submit-btn" style="display:none;">Submit</button>
    </nav>
</div>

<script>
let quizData = {{ quiz|tojson }};
let currentIndex = {{ index }};
let score = {{ score }};
let selectedAnswer = null;

const spinner = document.getElementById("loading-spinner");

function showSpinner() {
    spinner.classList.remove("hidden");
}

function hideSpinner() {
    spinner.classList.add("hidden");
}

function loadQuestion(idx) {
    let q = quizData[idx];
    document.getElementById("question").innerHTML = `Question ${idx + 1} of ${quizData.length}: ${q.question}`;

    let optionsContainer = document.getElementById("options");
    optionsContainer.innerHTML = "";
    q.options.forEach(opt => {
        let label = document.createElement("label");
        label.className = "quiz-option";
        label.innerHTML = `
            <input type="radio" name="answer" value="${opt}"/>
            <span class="custom-radio"></span>
            ${opt}
        `;
        optionsContainer.appendChild(label);
    });

    document.getElementById("feedback").innerHTML = "";
    document.getElementById("check-btn").style.display = "inline-block";
    document.getElementById("next-btn").style.display = "none";
    document.getElementById("submit-btn").style.display = "none";

    hideSpinner();
}


// Handle Check button
document.getElementById("check-btn").addEventListener("click", () => {
    showSpinner();

    setTimeout(() => {
        let selected = document.querySelector("input[name='answer']:checked");
        if (!selected) {
            alert("Please select an answer first!");
            hideSpinner();
            return;
        }

    let q = quizData[currentIndex];
    let feedbackBox = document.getElementById("feedback");

    if (selected.value === q.answer) {
        score++;
        feedbackBox.innerHTML = `<div style="background:rgba(79, 207, 83, 0.757); color:white; padding:10px; border-radius:8px;">
         Correct! ${q.explanation}
        </div>`;
    } else {
        feedbackBox.innerHTML = `<div style="background:rgba(233, 40, 60, 0.769); color:white; padding:10px; border-radius:8px;">
         Incorrect! ${q.explanation}
        </div>`;
    }

    document.getElementById("check-btn").style.display = "none";

    if (currentIndex < quizData.length - 1) {
        document.getElementById("next-btn").style.display = "inline-block";
    } else {
        document.getElementById("submit-btn").style.display = "inline-block";
    }
    hideSpinner();
    }, 500);
});


// Handle Next button
document.getElementById("next-btn").addEventListener("click", () => {
    showSpinner();
    setTimeout(() => {
        currentIndex++;
        loadQuestion(currentIndex);
    }, 500);
});

// Handle Final Submit button
document.getElementById("submit-btn").addEventListener("click", () => {
    showSpinner();
    setTimeout(() => {
        window.location.href = "{{ url_for('feedback') }}?score=" + score + "&total=" + quizData.length;
    }, 300); 
});



loadQuestion(currentIndex);
</script>
{% endblock %}