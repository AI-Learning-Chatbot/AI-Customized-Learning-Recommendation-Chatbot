{% extends 'base.html' %}

{% block head %}
<title>Quiz</title>
{% endblock %}

{% block main %}
<div class="quiz-box" id="quiz-box">
    <h2 class="question" id="question">
        {{ quiz[index].question }}
    </h2>

    <div class="option" id="options">
        {% for opt in quiz[index].options %}
        <label class="quiz-option">
            <input type="radio" name="answer" value="{{ opt }}"/>
            <span class="custom-radio"></span>
            {{ opt }}
        </label>
        {% endfor %}
    </div>

    <div class="feedback" id="feedback"></div>

    <nav class="quiz-nav">
        <button class="check-btn" id="check-btn">Check</button>
        <button class="next-btn" id="next-btn" style="display:none;">Next</button>
        <button class="submit-btn" id="submit-btn" style="display:none;">Submit</button>
    </nav>
</div>

<script>
let quizData = {{ quiz|tojson }};
let currentIndex = {{ index }};
let score = {{ score }};
let selectedAnswer = null;

function loadQuestion(idx) {
    let q = quizData[idx];
    document.getElementById("question").innerText = q.question;

    let optionsContainer = document.getElementById("options");
    optionsContainer.innerHTML = "";
    q.options.forEach(opt => {
        let label = document.createElement("label");
        label.className = "quiz-option";
        label.innerHTML = `
            <input type="radio" name="answer" value="${opt}"/>
            <span class="custom-radio"></span>
            ${opt}
        `;
        optionsContainer.appendChild(label);
    });

    document.getElementById("feedback").innerHTML = "";
    document.getElementById("check-btn").style.display = "inline-block";
    document.getElementById("next-btn").style.display = "none";
    document.getElementById("submit-btn").style.display = "none";
}

// Handle Check button
document.getElementById("check-btn").addEventListener("click", () => {
    let selected = document.querySelector("input[name='answer']:checked");
    if (!selected) {
        alert("Please select an answer first!");
        return;
    }

    let q = quizData[currentIndex];
    let feedbackBox = document.getElementById("feedback");

    if (selected.value === q.answer) {
        score++;
        feedbackBox.innerHTML = `<div style="background:green; color:white; padding:10px; border-radius:8px;">
            ✅ Correct! ${q.explanation}
        </div>`;
    } else {
        feedbackBox.innerHTML = `<div style="background:red; color:white; padding:10px; border-radius:8px;">
            ❌ Incorrect! ${q.explanation}
        </div>`;
    }

    document.getElementById("check-btn").style.display = "none";

    if (currentIndex < quizData.length - 1) {
        document.getElementById("next-btn").style.display = "inline-block";
    } else {
        document.getElementById("submit-btn").style.display = "inline-block";
    }
});

// Handle Next button
document.getElementById("next-btn").addEventListener("click", () => {
    currentIndex++;
    loadQuestion(currentIndex);
});

// Handle Final Submit button
document.getElementById("submit-btn").addEventListener("click", () => {
    // Redirect to feedback page with score
    window.location.href = "{{ url_for('feedback') }}?score=" + score + "&total=" + quizData.length;
});

// Initial load
loadQuestion(currentIndex);
</script>
{% endblock %}
