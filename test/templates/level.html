{% extends 'base.html' %}

{% block head %}
<title>Level</title>
{% endblock %}

{% block main %}
<!-- Spinner -->
<div id="loading-spinner" class="spinner hidden"></div>

<div class="level-box">
    <h2 class="level-title">How well do you<br/>understand this {{ topic }}:</h2>
    <div class="level">
        <button class="level-btn">Beginner</button>
        <button class="level-btn">Intermediate</button>
        <button class="level-btn">Advanced</button>
    </div>
    <nav class="proceed-nav">
        <!-- Hidden initially -->
        <button class="quiz-btn" style="display:none;">Take Quiz</button> 
        <button class="chat-btn" style="display:none;">Chat</button> 
    </nav>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    let selectedLevel = null;
    const spinner = document.getElementById("loading-spinner");
    const quizBtn = document.querySelector(".quiz-btn");
    const chatBtn = document.querySelector(".chat-btn");

    // Handle level selection
    document.querySelectorAll(".level-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".level-btn").forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");
            selectedLevel = btn.textContent.trim();

            quizBtn.style.display = "inline-block";
            chatBtn.style.display = "inline-block";
        });
    });

    // Quiz button click
    quizBtn.addEventListener("click", () => {
        if (!selectedLevel) {
            alert("Please select a level first!");
            return;
        }
        spinner.classList.remove("hidden");
        fetch("{{ url_for('set_level') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ level: selectedLevel, target: "quiz" })
        })
        .then(res => res.json())
        .then(data => {
            if (data.redirect) window.location.href = data.redirect;
            else spinner.classList.add("hidden");
        })
        .catch(() => spinner.classList.add("hidden"));
    });

    // Chat button click
    chatBtn.addEventListener("click", () => {
        if (!selectedLevel) {
            alert("Please select a level first!");
            return;
        }
        spinner.classList.remove("hidden");
        fetch("{{ url_for('set_level') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ level: selectedLevel, target: "chat" })
        })
        .then(res => res.json())
        .then(data => {
            if (data.redirect) window.location.href = data.redirect;
            else spinner.classList.add("hidden");
        })
        .catch(() => spinner.classList.add("hidden"));
    });

    // Hide spinner on page load
    window.addEventListener("load", () => {
        spinner.classList.add("hidden");
    });
});
</script>
{% endblock %}
